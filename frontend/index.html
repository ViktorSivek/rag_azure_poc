<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Telco RAG Chatbot (PoC)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg: #f6f7fb;
        --card: #fff;
        --muted: #6b7280;
        --border: #e5e7eb;
        --accent: #2563eb;
        --accent-strong: #1e40af;
        --user: #e9f0ff;
        --assistant: #f5f5f5;
        --radius: 14px;
        --shadow: 0 6px 24px rgba(0, 0, 0, 0.06), 0 2px 8px rgba(0, 0, 0, 0.04);
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: var(--bg);
        color: #0f172a;
        font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI,
          Roboto, Arial;
      }
      .wrap {
        max-width: 960px;
        margin: 36px auto;
        padding: 0 16px;
      }

      /* Header */
      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
      }
      .brand {
        font-weight: 700;
        font-size: 22px;
        letter-spacing: 0.2px;
      }
      .subbrand {
        color: var(--muted);
        font-weight: 500;
        margin-left: 8px;
        font-size: 14px;
      }
      .new-chat-btn {
        background: #fff;
        color: #111827;
        border: 1px solid var(--border);
        padding: 8px 16px;
        border-radius: 10px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
      }
      .new-chat-btn:hover {
        background: #f8fafc;
        border-color: #cbd5e1;
      }

      /* Compact Info Bar */
      .info-bar {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 12px 16px;
        margin-bottom: 16px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      }
      .info-content {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 20px;
        flex-wrap: wrap;
      }
      .info-main {
        flex: 1;
        min-width: 300px;
      }
      .info-title {
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 4px;
      }
      .info-desc {
        color: var(--muted);
        font-size: 13px;
        line-height: 1.4;
      }
      .info-sources {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: var(--muted);
      }
      .sources-toggle {
        background: none;
        border: none;
        color: var(--accent);
        cursor: pointer;
        font-size: 13px;
        text-decoration: underline;
        padding: 0;
      }
      .sources-toggle:hover {
        color: var(--accent-strong);
      }
      .sources-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 12px;
        box-shadow: var(--shadow);
        z-index: 10;
        min-width: 300px;
        max-width: 500px;
        display: none;
      }
      .sources-dropdown.show {
        display: block;
      }
      .sources-list {
        margin: 0;
        padding-left: 16px;
        font-size: 12px;
        line-height: 1.4;
      }
      .sources-list li {
        margin: 4px 0;
        color: var(--muted);
      }
      .info-sources-container {
        position: relative;
      }

      /* Suggestions */
      .sugg-card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        margin-bottom: 16px;
      }
      .sugg-title {
        margin: 0 0 10px 0;
        font-size: 14px;
        font-weight: 600;
      }
      .sugg-list {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .sugg {
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.2s ease;
      }
      .sugg:hover {
        border-color: var(--accent);
        background: #f8fafc;
      }

      /* Chat */
      .chat {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08),
          0 4px 16px rgba(0, 0, 0, 0.04);
        min-height: 400px;
        display: flex;
        flex-direction: column;
        gap: 16px;
        margin-bottom: 16px;
      }
      .message {
        display: flex;
        gap: 10px;
        align-items: flex-end;
        max-width: 85%;
      }
      .message.assistant {
        align-self: flex-start;
      }
      .message.user {
        align-self: flex-end;
        flex-direction: row-reverse;
      }
      .bubble {
        padding: 12px 14px;
        border-radius: 14px;
        line-height: 1.5;
        white-space: pre-wrap;
        font-size: 15px;
        border: 1px solid var(--border);
      }
      .assistant .bubble {
        background: var(--assistant);
      }
      .user .bubble {
        background: var(--user);
        border-color: #dbeafe;
      }
      .meta {
        font-size: 12px;
        color: var(--muted);
        margin-top: 2px;
      }

      /* Composer */
      .composer {
        position: relative;
        margin-top: 14px;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 12px 12px 56px 12px;
      }
      textarea {
        width: 100%;
        min-height: 120px;
        border: 0;
        outline: 0;
        resize: vertical;
        font: 15px/1.5 inherit;
        color: #111827;
        background: transparent;
      }
      .controls {
        position: absolute;
        right: 12px;
        bottom: 12px;
        left: 12px;
        display: flex;
        align-items: center;
      }
      .kbox {
        display: flex;
        align-items: center;
        gap: 6px;
        color: var(--muted);
        font-size: 13px;
      }
      .kbox input {
        width: 64px;
        padding: 6px 8px;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: #fff;
        font-size: 13px;
      }
      .send {
        margin-left: auto;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: var(--accent);
        color: #fff;
        border: 0;
        padding: 10px 14px;
        border-radius: 12px;
        cursor: pointer;
        box-shadow: 0 4px 14px rgba(37, 99, 235, 0.25);
      }
      .send:hover {
        background: var(--accent-strong);
      }
      .send[disabled] {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .spinner {
        width: 14px;
        height: 14px;
        border: 2px solid rgba(255, 255, 255, 0.6);
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      @media (max-width: 820px) {
        .info-content {
          flex-direction: column;
          align-items: flex-start;
          gap: 12px;
        }
        .info-main {
          min-width: auto;
        }
        .info-sources-container {
          align-self: flex-end;
        }
        .sources-dropdown {
          right: 0;
          left: auto;
          min-width: 280px;
        }
        .message {
          max-width: 100%;
        }
        .chat {
          min-height: 300px;
          padding: 16px;
        }
        .sugg-list {
          gap: 4px;
        }
        .sugg {
          padding: 6px 10px;
          font-size: 12px;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="header">
        <div>
          <span class="brand">Telco RAG Chatbot</span>
          <span class="subbrand">PoC</span>
        </div>
        <button id="newchat" class="new-chat-btn">New chat</button>
      </div>

      <div class="info-bar">
        <div class="info-content">
          <div class="info-main">
            <div class="info-title">Telco RAG Demo</div>
            <div class="info-desc">
              Ask about 5G technology, legislation, and cybersecurity. Built
              with Azure AI Search and OpenAI.
            </div>
          </div>
          <div class="info-sources-container">
            <div class="info-sources">
              <span>5 sources</span>
              <button class="sources-toggle" id="sources-toggle">
                View sources
              </button>
            </div>
            <div class="sources-dropdown" id="sources-dropdown">
              <ol class="sources-list">
                <li>
                  3GPP TS 23.501 — System Architecture for the 5G System (5GS);
                  Stage 2
                </li>
                <li>
                  BEREC Guidelines on the Implementation of the Open Internet
                  Regulation (Net Neutrality)
                </li>
                <li>
                  ENISA Technical Implementation Guidance for the EU 5G Toolbox
                </li>
                <li>
                  ETSI EN 300 328 — Wideband Data Transmission Systems (2.4 GHz)
                </li>
                <li>
                  Czech General Authorization VO‑R/12 — RLAN devices in the 5
                  GHz band
                </li>
              </ol>
            </div>
          </div>
        </div>
      </div>

      <div class="sugg-card">
        <h3 class="sugg-title">Try these questions</h3>
        <div class="sugg-list" id="suggs"></div>
      </div>

      <div id="chat" class="chat"></div>

      <div class="composer">
        <textarea
          id="q"
          placeholder="Ask a question… (Shift+Enter for new line)"
        ></textarea>
        <div class="controls">
          <div class="kbox">
            <label for="topk">k</label>
            <input id="topk" type="number" value="6" min="1" max="20" />
          </div>
          <button id="send" class="send"><span>Send</span></button>
        </div>
      </div>
    </div>

    <script>
      const el = (id) => document.getElementById(id);
      const chat = el("chat");
      const q = el("q");
      const sendBtn = el("send");

      // Map raw file names from API -> titles for display
      const SOURCE_LABELS = {
        "3GPP_TS_23.501":
          "3GPP TS 23.501 — System Architecture for the 5G System (5GS); Stage 2",
        "3GPP_TS_23.501.pdf":
          "3GPP TS 23.501 — System Architecture for the 5G System (5GS); Stage 2",
        BEREC_Guidelines:
          "BEREC Guidelines on the Implementation of the Open Internet Regulation (Net Neutrality)",
        "BEREC_Guidelines.pdf":
          "BEREC Guidelines on the Implementation of the Open Internet Regulation (Net Neutrality)",
        ENISA_Technical_implementation_guidance:
          "ENISA Technical Implementation Guidance for the EU 5G Toolbox",
        "ENISA_Technical_implementation_guidance.pdf":
          "ENISA Technical Implementation Guidance for the EU 5G Toolbox",
        ETSI_EN_300_328:
          "ETSI EN 300 328 — Wideband Data Transmission Systems (2.4 GHz)",
        "ETSI_EN_300_328.pdf":
          "ETSI EN 300 328 — Wideband Data Transmission Systems (2.4 GHz)",
        "Vseobecne_opravneni_VO-R-12":
          "Czech General Authorization VO‑R/12 — RLAN devices in the 5 GHz band",
        "Vseobecne_opravneni_VO-R-12.pdf":
          "Czech General Authorization VO‑R/12 — RLAN devices in the 5 GHz band",
      };
      const prettifySource = (name) =>
        SOURCE_LABELS[name] ||
        SOURCE_LABELS[name.replace(/\.pdf$/i, "")] ||
        name;

      // Suggestions (question-only; click to ask)
      const SUGGESTIONS = [
        "What are the two 5GS Registration Management states?",
        "What is the total downlink capacity for DOCSIS spectrum 1 OFDM channel with 192 MHz?",
        "What are the main categories of 5G security threats?",
        "What is the maximum mean e.i.r.p. and which clause states it?",
        "What is the maximum radiated power and spectral density for the 57-66 GHz frequency band?",
      ];

      function renderSuggestions() {
        const box = el("suggs");
        SUGGESTIONS.forEach((text) => {
          const item = document.createElement("div");
          item.className = "sugg";
          item.textContent = text;
          item.title = "Click to ask this question";
          item.addEventListener("click", () => {
            q.value = text;
            ask();
          });
          box.appendChild(item);
        });
      }

      function addMessage(role, text, sources) {
        const row = document.createElement("div");
        row.className = `message ${role}`;

        const bubble = document.createElement("div");
        bubble.className = "bubble";
        bubble.textContent = text || "";
        row.appendChild(bubble);

        chat.appendChild(row);

        if (role === "assistant" && sources && sources.length) {
          const pretty = sources.map(prettifySource);
          const meta = document.createElement("div");
          meta.className = "meta";
          meta.textContent = "Sources: " + pretty.join(", ");
          chat.appendChild(meta);
        }

        chat.scrollTop = chat.scrollHeight;
      }

      function setLoading(loading) {
        if (loading) {
          sendBtn.disabled = true;
          const spin = document.createElement("span");
          spin.className = "spinner";
          spin.setAttribute("aria-hidden", "true");
          sendBtn.appendChild(spin);
        } else {
          sendBtn.disabled = false;
          const s = sendBtn.querySelector(".spinner");
          if (s) s.remove();
        }
      }

      async function ask() {
        const question = q.value.trim();
        const top_k = Number(el("topk").value) || 6;
        if (!question) return;

        addMessage("user", question);
        q.value = "";
        setLoading(true);

        try {
          const resp = await fetch("/ask", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ question, top_k }),
          });
          const data = await resp.json();
          if (!resp.ok) throw new Error(data.detail || "Request failed");
          addMessage(
            "assistant",
            data.answer || "(no answer)",
            data.sources || []
          );
        } catch (e) {
          addMessage("assistant", `Error: ${e.message}`);
        } finally {
          setLoading(false);
          q.focus();
        }
      }

      function newChat() {
        chat.innerHTML = "";
        q.value = "";
        q.focus();
      }

      // Sources dropdown toggle
      function toggleSources() {
        const dropdown = el("sources-dropdown");
        const toggle = el("sources-toggle");
        const isVisible = dropdown.classList.contains("show");

        if (isVisible) {
          dropdown.classList.remove("show");
          toggle.textContent = "View sources";
        } else {
          dropdown.classList.add("show");
          toggle.textContent = "Hide sources";
        }
      }

      // Close dropdown when clicking outside
      function handleClickOutside(event) {
        const container = document.querySelector(".info-sources-container");
        const dropdown = el("sources-dropdown");

        if (
          container &&
          !container.contains(event.target) &&
          dropdown.classList.contains("show")
        ) {
          dropdown.classList.remove("show");
          el("sources-toggle").textContent = "View sources";
        }
      }

      // Events
      el("send").addEventListener("click", ask);
      el("newchat").addEventListener("click", newChat);
      el("sources-toggle").addEventListener("click", toggleSources);
      document.addEventListener("click", handleClickOutside);
      q.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          ask();
        }
      });

      // Init
      renderSuggestions();
    </script>
  </body>
</html>
